var f=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var E=f(o=>{var S=Object.create?function(i,t,e,r){r===void 0&&(r=e);var s=Object.getOwnPropertyDescriptor(t,e);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(i,r,s)}:function(i,t,e,r){r===void 0&&(r=e),i[r]=t[e]},m=Object.create?function(i,t){Object.defineProperty(i,"default",{enumerable:!0,value:t})}:function(i,t){i.default=t},h=function(){var i=function(t){return i=Object.getOwnPropertyNames||function(e){var r=[];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(r[r.length]=s);return r},i(t)};return function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r=i(t),s=0;s<r.length;s++)r[s]!=="default"&&S(e,t,r[s]);return m(e,t),e}}();Object.defineProperty(o,"__esModule",{value:!0});o.SecureTerminalUtils=o.SecureCommandRunner=void 0;const u=h(require("path")),a=require("../shared/security-config");class l{static validatePowerShellSyntax(t){return a.SHARED_SECURITY_CONFIG.SAFE_POWERSHELL_PATTERNS.some(e=>e.test(t))}static validateCommand(t){if(!t||typeof t!="string")return!1;const e=t.trim();if(e.length===0)return!1;if(this.SAFE_COMMAND_PATTERNS.some(n=>n.test(e)))return console.log(`Command whitelisted: ${e}`),!0;if((e.toLowerCase().includes("powershell")||e.includes("$")||e.includes("Get-")||e.includes("Stop-Process"))&&this.validatePowerShellSyntax(e))return console.log(`PowerShell command validated: ${e}`),!0;if(this.DANGEROUS_PATTERNS.some(n=>n.test(e)))return console.warn(`Dangerous pattern detected: ${e}`),!1;const r=e.split(/\s+/)[0].toLowerCase();return r==="npm"?this.validateNpmCommand(e):r==="powershell.exe"||e.startsWith(".\\scripts\\")?this.validatePowerShellCommand(e):this.ALLOWED_COMMANDS.has(r)||this.ALLOWED_COMMANDS.has(r.replace(".exe",""))?!0:(console.warn(`Command blocked - not in allowed list: ${r}`),!1)}static validateCommandEnhanced(t){if(!t||typeof t!="string")return{valid:!1,reason:"invalid-input",message:(0,a.getSecurityErrorMessage)(t||"","invalid-input")};const e=t.trim();if(e.length===0)return{valid:!1,reason:"empty-command",message:(0,a.getSecurityErrorMessage)(e,"empty-command")};if(this.SAFE_COMMAND_PATTERNS.some(n=>n.test(e)))return console.log(`Command whitelisted: ${e}`),{valid:!0};if(e.toLowerCase().includes("powershell")||e.includes("$")||e.includes("Get-")||e.includes("Stop-Process"))return this.validatePowerShellSyntax(e)?(console.log(`PowerShell command validated: ${e}`),{valid:!0}):{valid:!1,reason:"powershell-syntax",message:(0,a.getSecurityErrorMessage)(e,"powershell-syntax")};if(this.DANGEROUS_PATTERNS.some(n=>n.test(e)))return console.warn(`Dangerous pattern detected: ${e}`),{valid:!1,reason:"dangerous-pattern",message:(0,a.getSecurityErrorMessage)(e,"dangerous-pattern")};const r=e.split(/\s+/)[0].toLowerCase();return r==="npm"?this.validateNpmCommand(e)?{valid:!0}:{valid:!1,reason:"not-whitelisted",message:(0,a.getSecurityErrorMessage)(e,"not-whitelisted")}:r==="powershell.exe"||e.startsWith(".\\scripts\\")?this.validatePowerShellCommand(e)?{valid:!0}:{valid:!1,reason:"powershell-syntax",message:(0,a.getSecurityErrorMessage)(e,"powershell-syntax")}:this.ALLOWED_COMMANDS.has(r)||this.ALLOWED_COMMANDS.has(r.replace(".exe",""))?{valid:!0}:(console.warn(`Command blocked - not in allowed list: ${r}`),{valid:!1,reason:"not-whitelisted",message:(0,a.getSecurityErrorMessage)(e,"not-whitelisted")})}static validateNpmCommand(t){const e=t.split(/\s+/);if(e.length<2)return!1;const r=e[1].toLowerCase();if(r==="run"&&e.length>=3){const s=e[2].toLowerCase();return this.ALLOWED_NPM_SCRIPTS.has(s)}return this.ALLOWED_NPM_SCRIPTS.has(r)}static validatePowerShellCommand(t){return t.startsWith(".\\scripts\\")?t.split(/\s+/)[0].endsWith(".ps1"):t.toLowerCase().includes("powershell.exe")?["-ExecutionPolicy","Bypass","-File"].some(s=>t.includes(s))&&t.includes(".ps1"):!1}static sanitizePath(t,e){if(!t||typeof t!="string")throw new Error("Invalid file path provided");if(!e||typeof e!="string")throw new Error("Invalid workspace root provided");const r=u.normalize(t),s=u.resolve(e,r),n=u.resolve(e);if(!s.startsWith(n))throw new Error(`Path traversal detected: ${t} resolves outside workspace`);return s}static validateFileExtension(t){if(!t||typeof t!="string")return!1;const e=u.extname(t).toLowerCase();return this.ALLOWED_EXTENSIONS.has(e)}static escapeFilePath(t){return!t||typeof t!="string"?"":process.platform==="win32"?t.includes(" ")?`"${t}"`:t:t.replace(/(["\s'$`\\])/g,"\\$1")}static validateEnvironmentVariable(t){return!t||typeof t!="string"?!1:/^[A-Z_][A-Z0-9_]*$/i.test(t)}static createSecureCommand(t,e=[],r={}){if(!this.validateCommand(t))return null;let s=t;if(e.length>0){const n=e.map(d=>typeof d!="string"?"":d.replace(/[;&|`$(){}[\]\\]/g,"")).filter(d=>d.length>0);s+=" "+n.join(" ")}if(r.workingDir)try{s=`cd "${this.sanitizePath(r.workingDir,process.cwd())}" && ${s}`}catch(n){return console.error("Invalid working directory:",n),null}return this.validateCommand(s)?s:null}}o.SecureCommandRunner=l;l.ALLOWED_COMMANDS=new Set(a.SHARED_SECURITY_CONFIG.ALLOWED_COMMANDS);l.ALLOWED_NPM_SCRIPTS=new Set(a.SHARED_SECURITY_CONFIG.ALLOWED_NPM_SCRIPTS);l.DANGEROUS_PATTERNS=a.SHARED_SECURITY_CONFIG.DANGEROUS_PATTERNS;l.ALLOWED_EXTENSIONS=new Set(a.SHARED_SECURITY_CONFIG.ALLOWED_EXTENSIONS);l.SAFE_COMMAND_PATTERNS=a.SHARED_SECURITY_CONFIG.SAFE_COMMAND_PATTERNS;class p{static sendSecureCommand(t,e,r={validate:!0}){if(r.validate&&!l.validateCommand(e))return console.error(`Command blocked for security reasons: ${e}`),!1;try{return t.sendText(e),!0}catch(s){return console.error("Failed to send command to terminal:",s),!1}}static sendSecureProjectCommand(t,e,r,s){try{const n=l.sanitizePath(e,s);if(!l.validateCommand(r))return console.error(`Command blocked: ${r}`),!1;const c=`cd ${l.escapeFilePath(n)} && ${r}`;return t.sendText(c),!0}catch(n){return console.error("Failed to send secure project command:",n),!1}}}o.SecureTerminalUtils=p});export default E();
